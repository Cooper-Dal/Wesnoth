#textdomain wesnoth-loti
[scenario]
	id=23_Akulas_Place
	name= _ "Akula's Place"
	map_data="{~add-ons/Legend_of_the_Invincibles/maps/23_Akulas_Place.map}"
	{GLOBAL_EVENTS}
	{SCENARIO_MUSIC "battle-epic.ogg"}
	{EXTRA_SCENARIO_MUSIC "battle.ogg"}
	{EXTRA_SCENARIO_MUSIC "vengeful.ogg"}
	turns=-1
	{DEEP_UNDERGROUND}
	next_scenario=29_Armageddon
	victory_when_enemies_defeated=no
	[story]
		[part]
			background=maps/antediluvian_tunnels_map.png
			show_title=yes
			[image]
				x,y=303,189
				file=misc/red-x.png
				centered=yes
			[/image]
			story=""
		[/part]
	[/story]
	{SPAWN_POINT 2 2 5 5}
	{SPAWN_POINT 2 2 15 4}
	{SPAWN_POINT 2 2 21 4}
	{SPAWN_POINT 2 2 25 5}
	{SPAWN_POINT 2 3 33 6}
	{SPAWN_POINT 2 2 42 5}
	{SPAWN_POINT 2 2 45 15}
	{SPAWN_POINT 2 2 46 19}
	{SPAWN_POINT 2 2 43 26}
	{SPAWN_POINT 2 2 30 27}
	{SPAWN_POINT 2 2 26 34}
	{SPAWN_POINT 2 2 19 27}
	{SPAWN_POINT 2 2 9 20}
	{SPAWN_POINT 2 2 19 20}
	{SPAWN_POINT 2 2 32 21}
	{SPAWN_POINT 2 2 36 16}
	[event]
		name=prestart
		[objectives]
			side=1
			[objective]
				description= _ "Defeat Akula"
				condition=win
			[/objective]
			[objective]
				description= _ "Destruction of Efraim or Lethalia"
				condition=lose
			[/objective]
		[/objectives]
		{ORIGIN 20 41,35}
		{ORIGIN 18 53,23}
		{ORIGIN 11 46,2}
		[recall]
			id=Lethalia
		[/recall]
		{PLACE_IMAGE scenery/monolith2.png 52 9}
#ifdef HARD
		{VARIABLE no_fast_ai 6}  # allied leader will run for healing BEFORE recruiting if he is hit by catapult
#endif
#ifdef HARD
		[switch]
			variable=last_scenario
			[case]
				value=11
				{TRANSITION 54-56,21-25 55,23 _"Eastern Guardian Room" 18_Eastern_Guardian_Room}
				{TRANSITION 38-44,35-37 42,36 _"Southern Guardian Room" 20_Southern_Guardian_Room}
				{TRANSITION 0-2,17-20 2,17 _"Escape Tunnel" 24_Escape_Tunnel}
			[/case]
			[case]
				value=18
				{TRANSITION 44-49,0-2 46,1 _"Northern Guardian Room" 11_Northern_Guardian_Room}
				{TRANSITION 38-44,35-37 42,36 _"Southern Guardian Room" 20_Southern_Guardian_Room}
				{TRANSITION 0-2,17-20 2,17 _"Escape Tunnel" 24_Escape_Tunnel}
			[/case]
			[case]
				value=20
				{TRANSITION 44-49,0-2 46,1 _"Northern Guardian Room" 11_Northern_Guardian_Room}
				{TRANSITION 54-56,21-25 55,23 _"Eastern Guardian Room" 18_Eastern_Guardian_Room}
				{TRANSITION 0-2,17-20 2,17 _"Escape Tunnel" 24_Escape_Tunnel}
			[/case]
			[case]
				value=24
				{TRANSITION 44-49,0-2 46,1 _"Northern Guardian Room" 11_Northern_Guardian_Room}
				{TRANSITION 54-56,21-25 55,23 _"Eastern Guardian Room" 18_Eastern_Guardian_Room}
				{TRANSITION 38-44,35-37 42,36 _"Southern Guardian Room" 20_Southern_Guardian_Room}
			[/case]
		[/switch]
#else
		{TRANSITION 44-49,0-2 46,1 _"Northern Guardian Room" 11_Northern_Guardian_Room}
		{TRANSITION 54-56,21-25 55,23 _"Eastern Guardian Room" 18_Eastern_Guardian_Room}
		{TRANSITION 38-44,35-37 42,36 _"Southern Guardian Room" 20_Southern_Guardian_Room}
		{TRANSITION 0-2,17-20 2,17 _"Escape Tunnel" 24_Escape_Tunnel}
#endif
#ifdef HARD
		{VARIABLE spawn_freq_accel 1.05}
#endif
#ifdef HARD
		[terrain] # side 3 castle
			terrain=Cud
			x=   16,17,17,19,19,   20
			y=10-12,10,13,10,13,10-12
		[/terrain]
		[terrain]
			terrain=Cud^Kov
			x=18,18
			y= 9,13
		[/terrain]
		[terrain] # side 4 castle
			terrain=Cud
			x=   30,31,31,33,33,   34
			y=10-12,10,13,10,13,10-12
		[/terrain]
		[terrain]
			terrain=Cud^Kov
			x=32,32
			y= 9,13
		[/terrain]
		[terrain] # side 5 castle
			terrain=Cud
			x=   23,24,24,26,26,   27
			y=21-23,20,23,20,23,21-23
		[/terrain]
		[terrain]
			terrain=Cud^Kov
			x=25,25
			y=20,24
		[/terrain]
#endif
#ifdef HARD
		[terrain]
			terrain=Urb
			x=4, 4,54,54
			y=1,35, 1,35
		[/terrain]
		[unit]
			side=2
			id=catapult1
			type=Catapult
			x,y=4,1
			[attack]
				name=napalm
				range=ranged
				type=fire
				damage=16
				number=1
				[specials]
					[damage]
						id=inaccurate
						name=_"inaccurate"
						description= _ "This attack occurs at long range, sometimes even striking close to its intended target."
					[/damage]
					[damage]
						id=splash
						name= _ "splash"
						description= _ "When this attack is used, all units adjacent to the point of impact take 50% of the damage."
					[/damage]
					{WEAPON_SPECIAL_INCINERATE}
					[damage]
						id=splash incinerate
						name=_"splash incinerate"
						description= _ "When this attack is used, all units adjacent to the point of impact are incinerated."
					[/damage]
				[/specials]
			[/attack]
		[/unit]
		[unit]
			side=2
			id=catapult2
			type=Catapult
			x,y=54,1
			[attack]
				name=flechettes
				range=ranged
				type=pierce
				damage=16
				number=1
				[specials]
					[damage]
						id=inaccurate
						name=_"inaccurate"
						description= _ "This attack occurs at long range, sometimes even striking close to its intended target."
					[/damage]
					[damage]
						id=splash
						name= _ "splash"
						description= _ "When this attack is used, all units adjacent to the point of impact take 50% of the damage."
					[/damage]
					[damage]
						id=splash slow
						name=_"splash slow"
						description= _ "When this attack is used, all units adjacent to the point of impact are slowed."
					[/damage]
				[/specials]
			[/attack]
		[/unit]
		[unit]
			side=2
			id=catapult3
			type=Catapult
			x,y=4,35
			[attack]
				name=diseased livestock
				range=ranged
				type=impact
				damage=16
				number=1
				[specials]
					[damage]
						id=inaccurate
						name=_"inaccurate"
						description= _ "This attack occurs at long range, sometimes even striking close to its intended target."
					[/damage]
					[damage]
						id=splash
						name= _ "splash"
						description= _ "When this attack is used, all units adjacent to the point of impact take 50% of the damage."
					[/damage]
					[damage]
						id=splash poison
						name=_"splash poison"
						description= _ "When this attack is used, all units adjacent to the point of impact are poisoned."
					[/damage]
				[/specials]
			[/attack]
		[/unit]
		[unit]
			side=2
			id=catapult4
			type=Catapult
			x,y=54,35
			[attack]
				name=shrapnel
				range=ranged
				type=blade
				damage=16
				number=1
				[specials]
					[damage]
						id=inaccurate
						name=_"inaccurate"
						description= _ "This attack occurs at long range, sometimes even striking close to its intended target."
					[/damage]
					[damage]
						id=splash
						name= _ "splash"
						description= _ "When this attack is used, all units adjacent to the point of impact take 50% of the damage."
					[/damage]
					[damage]
						id=splash slow
						name=_"splash slow"
						description= _ "When this attack is used, all units adjacent to the point of impact are slowed."
					[/damage]
				[/specials]
			[/attack]
		[/unit]
#endif
#ifdef HARD
		[if]
			[variable]
				name=ch5_quests.sc11.done
				not_equals=yes
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=enemy
					[/filter]
					[object]
						[effect]
							apply_to=new_ability
							[abilities]
								{ABILITY_LEADERSHIP_LEVEL 7}
								{ABILITY_BACKSTAB_LEADERSHIP}
								{ABILITY_WEAK_REFLECT_AURA}
							[/abilities]
						[/effect]
						[effect]
							apply_to=resistance
							replace=true
							[resistance]
								fire=2
								pierce=2
							[/resistance]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
		[if]
			[variable]
				name=ch5_quests.sc18.done
				not_equals=yes
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=enemy2
					[/filter]
					[object]
						[effect]
							apply_to=new_ability
							[abilities]
								{ABILITY_LEADERSHIP_LEVEL 7}
								{ABILITY_NORTHFROST_AURA}
								{ABILITY_THORNS_AURA}
							[/abilities]
						[/effect]
						[effect]
							apply_to=resistance
							replace=true
							[resistance]
								blade=2
								cold=2
							[/resistance]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]
		[if]
			[variable]
				name=ch5_quests.sc20.done
				not_equals=yes
			[/variable]
			[then]
				[modify_unit]
					[filter]
						id=enemy3
					[/filter]
					[object]
						[effect]
							apply_to=new_ability
							[abilities]
								{ABILITY_LEADERSHIP_LEVEL 7}
								{ABILITY_REFLECT_AURA}
							[/abilities]
						[/effect]
						[effect]
							apply_to=resistance
							replace=true
							[resistance]
								arcane=2
								impact=2
							[/resistance]
						[/effect]
					[/object]
				[/modify_unit]
			[/then]
		[/if]

#endif
	[/event]
	{RECALL_ALL}
	[side]
		type=Efraim_lich
		id=Efraim
		name=_"Efraim"
		canrecruit=yes
		side=1
		controller=human
		{QUANTITY recruit "Skeleton,Skeleton Archer,Revenant,Deathblade,Bone Shooter,Ghost,Shadow,Wraith,Chocobone"
		"Skeleton,Skeleton Archer,Revenant,Deathblade,Bone Shooter,Ghost,Shadow,Wraith,Chocobone"
		"Skeleton,Skeleton Archer,Ghost" }
		gold=0
		income=0
		team_name=good
		user_team_name=_"Good"
		village_gold=1
	[/side]
	[side]
		name=Akula
		id=Akula
		type=Akula_steel_finale
		side=2
		canrecruit=yes
		{QUANTITY recruit "Javelineer_steel,Dark Sorcerer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,Lieutenant_steel"
		"Javelineer_steel,Dark Sorcerer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,Lieutenant_steel"
		"Javelineer_steel,Necromancer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,General_steel" }
		{GOLD 200 250 500}
		{INCOME 30 40 110}
		{QUANTITY village_gold 1 2 4}  # make stealing villages important vs blind charge, might want to go higher (double on normal/hard?)
		{QUANTITY village_support 1 2 4}
		team_name="Dreadful Evil"
		user_team_name=_"Dreadful Evil"
		{AI_OVERHAUL_PLACE 2}
#ifndef EASY
		[modifications]
			[object]
				[effect]
					apply_to=alignment
					set=liminal
				[/effect]
			[/object]
		[/modifications]
#endif
	[/side]
	[side]
		generate_name=yes
		id=enemy
		type=Necromancer_steel
		side=3
		canrecruit=yes
		{QUANTITY recruit "Spearman_steel,Dark Adept_steel,Fencer_steel,Bowman_steel"
		"Spearman_steel,Dark Adept_steel,Fencer_steel,Bowman_steel"
		"Javelineer_steel,Dark Sorcerer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,Lieutenant_steel" }
		{GOLD 100 150 400}
		{INCOME 20 30 70}
		random_traits=yes
		team_name="Dreadful Evil"
		user_team_name=_"Dreadful Evil"
		{AI_OVERHAUL_PLACE 3}
		{AI_OVERHAUL_PLACE_2 3}
		[object]  # this doesn't do anything
			[effect]
				apply_to=movement_costs
				replace="true"
				[movement_costs]
					flat={UNREACHABLE}
				[/movement_costs]
			[/effect]
		[/object]
	[/side]
	[side]
		generate_name=yes
		id=enemy2
		type=Necromancer_steel
		side=4
		canrecruit=yes
		{QUANTITY recruit "Spearman_steel,Dark Adept_steel,Fencer_steel,Bowman_steel"
		"Spearman_steel,Dark Adept_steel,Fencer_steel,Bowman_steel,Lieutenant_steel"
		"Javelineer_steel,Dark Sorcerer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,General_steel" }
		{GOLD 100 150 400}
		{INCOME 20 30 70}
		random_traits=yes
		team_name="Dreadful Evil"
		user_team_name=_"Dreadful Evil"
		{AI_OVERHAUL_PLACE 4}
		{AI_OVERHAUL_PLACE_2 4}
		[object]
			[effect]
				apply_to=movement_costs
				replace="true"
				[movement_costs]
					flat={UNREACHABLE}
				[/movement_costs]
			[/effect]
		[/object]
	[/side]
	[side]
		generate_name=yes
		id=enemy3
		type=Necromancer_steel
		side=5
		canrecruit=yes
		{QUANTITY recruit "Spearman_steel,Dark Adept_steel,Fencer_steel,Bowman_steel"
		"Spearman_steel,Dark Adept_steel,Fencer_steel,Bowman_steel,Lieutenant_steel"
		"Javelineer_steel,Dark Sorcerer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,General_steel" }
		{GOLD 100 150 400}
		{INCOME 20 30 70}
		random_traits=yes
		team_name="Dreadful Evil"
		user_team_name=_"Dreadful Evil"
		{AI_OVERHAUL_PLACE 5}
		{AI_OVERHAUL_PLACE_2 5}
		[object]
			[effect]
				apply_to=movement_costs
				replace="true"
				[movement_costs]
					flat={UNREACHABLE}
				[/movement_costs]
			[/effect]
		[/object]
	[/side]
	[side]
		generate_name=yes
		id=ally
		type=Dwarvish Lord
		side=6
		canrecruit=yes
		recruit=Dwarvish Steelclad,Dwarvish Fighter,Dwarvish Berserker,Dwarvish Stalwart,Dwarvish Thunderguard
		{GOLD 800 700 600}
		{INCOME 100 75 20}
		random_traits=yes
		team_name=good
		user_team_name=_"Good"
	[/side]
	[side]
		no_leader=yes
		side=7
		team_name=good
		user_team_name=_"Good"
		[unit]
			type=Ancient Warrior
			x,y=52,7
			facing=s
			generate_name=yes
			random_traits=yes
		[/unit]
		[unit]
			type=Ancient Warrior
			x,y=54,8
			facing=sw
			generate_name=yes
			random_traits=yes
		[/unit]
		[unit]
			type=Ancient Warrior
			x,y=50,8
			facing=se
			generate_name=yes
			random_traits=yes
		[/unit]
		[unit]
			type=Ancient Warrior
			x,y=52,11
			facing=n
			generate_name=yes
			random_traits=yes
		[/unit]
		[unit]
			type=Ancient Warrior
			x,y=50,10
			facing=ne
			generate_name=yes
			random_traits=yes
		[/unit]
		[unit]
			type=Ancient Warrior
			x,y=54,10
			facing=nw
			generate_name=yes
			random_traits=yes
		[/unit]
	[/side]

	[event]
		name=start
#ifdef EASY
		{VARIABLE efraim_spells_left 4}
		{VARIABLE lethalia_spells_left 4}
#endif
#ifdef NORMAL
		{VARIABLE efraim_spells_left 2}
		{VARIABLE lethalia_spells_left 2}
#endif
#ifdef HARD
		{VARIABLE efraim_spells_left 0}
		{VARIABLE lethalia_spells_left 0}
#endif
		{VARIABLE last_scenario 23}
		{MODIFY_UNIT side=7 status.petrified yes}

		# BEGIN populate Akula's team's castles
		[store_starting_location]
			side=2
			variable=start_loc
		[/store_starting_location]
		[store_locations]
			terrain=Cud^Ii,Cud^Kov
			[and]
				x=$start_loc.x
				y=$start_loc.y
				radius=2
			[/and]
			variable=side_locs
		[/store_locations]
		[foreach]
			array=side_locs
			[do]
#ifdef HARD
				{VARIABLE_OP freak_type rand (Javelineer_steel,Necromancer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,General_steel)}
#else
				{VARIABLE_OP freak_type rand (Javelineer_steel,Dark Sorcerer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,Lieutenant_steel)}
#endif
				{GENERIC_UNIT 2 $freak_type $this_item.x $this_item.y}
			[/do]
		[/foreach]
#ifdef HARD
		[modify_unit]
			[filter]
				side=2
			[/filter]
			upkeep=loyal
			[modifications]
				[object]
					[effect]
						apply_to=movement_costs
						replace="true"
						[movement_costs]
							unwalkable=2
						[/movement_costs]
					[/effect]
				[/object]
			[/modifications]
		[/modify_unit]
#endif
		[for]
			variable=side
			start=3
			end=5
			[do]
				[store_starting_location]
					side=$side
					variable=start_loc
				[/store_starting_location]
				[store_locations]
					terrain=Cud,Cud^Kov
					[and]
						x=$start_loc.x
						y=$start_loc.y
						{QUANTITY radius 1 1 2}
					[/and]
					variable=side_locs
				[/store_locations]
				[foreach]
					array=side_locs
					[do]
#ifdef HARD
						{VARIABLE_OP freak_type rand (Javelineer_steel,Necromancer_steel,Duelist_steel,Longbowman_steel,Swordsman_steel,General_steel)}
#else
						{VARIABLE_OP freak_type rand (Spearman_steel,Dark Adept_steel,Fencer_steel,Bowman_steel)}
#endif
						{GENERIC_UNIT $side $freak_type $this_item.x $this_item.y}
					[/do]
				[/foreach]
			[/do]
		[/for]
		{CLEAR_VARIABLE start_loc,side_locs,freak_type}
		# END populate Akula's team's castles

		[place_shroud]
			side=1
			x,y=57-56,5-13
		[/place_shroud]
		[if]
			[variable]
				name=ch5_quests.sc28.done
				equals=yes
			[/variable]
			[else]
				[kill]
					id=ally
					animate=no
					fire_event=no
				[/kill]
			[/else]
		[/if]
		[if]
			[variable]
				name=ch5_quests.amplificators.1.destroyed
				equals=yes
			[/variable]
			[then]
				[object]
					silent=yes
					duration=forever
					[filter]
						id=Akula
					[/filter]
					[effect]
						apply_to=attack
						{QUANTITY increase_attacks -50% -40% -20%}
					[/effect]
				[/object]
			[/then]
		[/if]
		[if]
			[variable]
				name=ch5_quests.amplificators.2.destroyed
				equals=yes
			[/variable]
			[then]
				[object]
					silent=yes
					duration=forever
					[filter]
						id=Akula
					[/filter]
					[effect]
						apply_to=attack
						{QUANTITY increase_damage -50% -40% -20%}
					[/effect]
				[/object]
			[/then]
		[/if]
		[if]
			[variable]
				name=ch5_quests.amplificators.3.destroyed
				equals=yes
			[/variable]
			[then]
				[object]
					silent=yes
					duration=forever
					[filter]
						id=Akula
					[/filter]
					[effect]
						apply_to=hitpoints
						{QUANTITY increase_total -40% -30% -10%}
						{QUANTITY increase -40% -30% -10%}
					[/effect]
					[effect]
						apply_to=attack
						{QUANTITY increase_damage -10% -8% -6%}
					[/effect]
				[/object]
			[/then]
		[/if]
		[if]
			[variable]
				name=ch5_quests.amplificators.4.destroyed
				equals=yes
			[/variable]
			[then]
				[object]
					silent=yes
					duration=forever
					[filter]
						id=Akula
					[/filter]
					[effect]
						apply_to=hitpoints
						{QUANTITY increase_total -40% -30% -10%}
						{QUANTITY increase -40% -30% -10%}
					[/effect]
					[effect]
						apply_to=attack
						{QUANTITY increase_damage -10% -8% -6%}
					[/effect]
				[/object]
			[/then]
		[/if]
		[if]
			[variable]
				name=ch5_quests.sc23.visited
				equals=yes
			[/variable]
			[else]
				[message]
					speaker=Akula
					message= _ "So you have come. The lack of organisation in this society is annoying to me as well."  # As well as what?
				[/message]
				[message]
					speaker=Lethalia
					message= _ "Your end is drawing near, Akula. I will enjoy killing you slowly, removing limb after limb, and then finally tearing away your blackened heart and devouring your soul. I have even created a special place for your soul."
				[/message]
				[message]
					speaker=Efraim
					message= _ "What is happening with you? You never spoke like this before!"
				[/message]
				[message]
					speaker=Lethalia
					message= _ "(closes her eyes and tries to concentrate) Something is happening to me. I said before that my soul is splitting somehow. The other part is more prone to get affected by emotions, and in this case it is only anger I find."
				[/message]
				[message]
					speaker=Efraim
					message= _ "That is a lesser problem. I fear that the darkness of your undead existence is corrupting you. We will seek help, after we get this done."
				[/message]
				[message]
					speaker=Lethalia
					message= _ "If it is as bad as you say, hope that I will not attack you."
				[/message]
				[message]
					speaker=Akula
					message= _ "I am not waiting for you to finish your lovely chat."
				[/message]
				[message]
					speaker=ally
					message= _ "I will make sure the good will prevail, as my comrade promised!"
					[show_if]
						[have_unit]
							id=ally
						[/have_unit]
					[/show_if]
				[/message]
				[message]
					speaker=Efraim
					message= _ "You can not stand a chance against us. Prepare to die, you hideous archdevil!"
				[/message]
				{VARIABLE ch5_quests.sc23.visited yes}
			[/else]
		[/if]
		[if]
			[variable]
				name=ch5_quests.sc23.sisters_chat
				equals=yes
			[/variable]
			[else]
				[if]
					[have_unit]
						id=akulas_sister
					[/have_unit]
					[then]
						[message]
							speaker=Akula
							message= _ "Manta, my sister, what are you doing here? I locked you up in that prison to prevent you from harming yourself in your naïvity. These invaders surely told you something really bad and made you follow them."
						[/message]
						[message]
							speaker=akulas_sister
							message= _ "Akula, my sister, what are you doing here? I wanted to prevent you from harming everybody in your naïvity. These friends of yours surely told you something really bad and made you follow them."   # this makes little sense, especially the part about Akula having friends and following them. This sounds like it should be Akula speaking, not Manta.
							mirror=yes
							image_pos=right
						[/message]
						[message]
							speaker=Akula
							message= _ "You are the one who cannot see the fruits my plan will bring. You may see me manipulated or even naïve, but believe me, you are the one whose mind is shrouded in mist. But it is good that you came to me, I will return you to the special care that you need."
						[/message]
						[message]
							speaker=akulas_sister
							message= _ "You are the one who will meet her doom today and I think that it is independent of my decisions. I assume that they will let you live if you lay down your weapons so that you might redeem yourself. If you do not, I can only ask them for mercy to restore your ravaged body."   # 'to be merciful and restore'?
							mirror=yes
							image_pos=right
						[/message]
						[message]
							speaker=Akula
							message= _ "You will <i>never</i> convince me of that. Let us finish this."
						[/message]
						{VARIABLE ch5_quests.sc23.sisters_chat yes}
					[/then]
				[/if]
			[/else]
		[/if]
	[/event]
	[event]
		name=attacker hits,attacker misses
		first_time_only=no
		[filter_attack]
			range=melee
		[/filter_attack]
		[filter_second]
			id=Akula
		[/filter_second]
		[switch]
			variable=ch5_quests.amplificators.destroyed_count
			[case]
				value=4
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					[filter_second]
						x,y=$x2,$y2
					[/filter_second]
					amount=10
					{QUANTITY damage_type pierce pierce lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=3
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					[filter_second]
						x,y=$x2,$y2
					[/filter_second]
					amount=20
					{QUANTITY damage_type pierce pierce lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=2
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					[filter_second]
						x,y=$x2,$y2
					[/filter_second]
					amount=30
					{QUANTITY damage_type pierce pierce lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=1
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					[filter_second]
						x,y=$x2,$y2
					[/filter_second]
					amount=40
					{QUANTITY damage_type pierce pierce lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=0
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					[filter_second]
						x,y=$x2,$y2
					[/filter_second]
					amount=50
					{QUANTITY damage_type pierce pierce lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
		[/switch]
	[/event]
	[event]
		name=defender hits,defender misses
		first_time_only=no
		[filter]
			id=Akula
		[/filter]
		[filter_attack]
			range=melee
		[/filter_attack]
		[switch]
			variable=ch5_quests.amplificators.destroyed_count
			[case]
				value=4
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					[filter_second]
						x,y=$x1,$y1
					[/filter_second]
					amount=10
					damage_type=pierce
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=3
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					[filter_second]
						x,y=$x1,$y1
					[/filter_second]
					amount=20
					damage_type=pierce
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=2
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					[filter_second]
						x,y=$x1,$y1
					[/filter_second]
					amount=30
					damage_type=pierce
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=1
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					[filter_second]
						x,y=$x1,$y1
					[/filter_second]
					amount=40
					damage_type=pierce
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=0
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					[filter_second]
						x,y=$x1,$y1
					[/filter_second]
					amount=50
					damage_type=pierce
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
		[/switch]
	[/event]

	[event]
		name=attacker hits
		first_time_only=no
		[filter_attack]
			range=melee
		[/filter_attack]
		[filter_second]
			side=2,3,4,5
		[/filter_second]
		[if]
			[variable]
				name=unit.x
				greater_than=20
			[/variable]
			[and]
				[variable]
					name=unit.x
					less_than=33
				[/variable]
			[/and]
			[and]
				[variable]
					name=unit.y
					less_than=19
				[/variable]
			[/and]
			[and]
				[variable]
					name=unit.y
					greater_than=10
				[/variable]
			[/and]
			[then]
				[animate_unit]
					flag=pre_teleport
					[filter]
						x,y=$x2,$y2
					[/filter]
					[animate]
						[filter]
							id=Akula
						[/filter]
						flag=attack
						[primary_attack]
							range=ranged
						[/primary_attack]
						hits=yes
					[/animate]
				[/animate_unit]
			[/then]
			[else]
				[animate_unit]
					flag=pre_teleport
					[filter]
						x,y=$x2,$y2
					[/filter]
				[/animate_unit]
			[/else]
		[/if]
		[switch]
			variable=ch5_quests.amplificators_destroyed
			[case]
				value=4
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					amount=2
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=3
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					{QUANTITY damage_type fire fire lightning}
					damage_type=fire
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=2
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					amount=5
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=1
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					amount=7
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=0
				[harm_unit]
					[filter]
						x,y=$x1,$y1
					[/filter]
					amount=10
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
		[/switch]
	[/event]
	[event]
		name=defender hits
		first_time_only=no
		[filter_attack]
			range=melee
		[/filter_attack]
		[filter]
			side=2,3,4,5
		[/filter]
		[if]
			[variable]
				name=unit.x
				greater_than=20
			[/variable]
			[and]
				[variable]
					name=unit.x
					less_than=33
				[/variable]
			[/and]
			[and]
				[variable]
					name=unit.y
					less_than=19
				[/variable]
			[/and]
			[and]
				[variable]
					name=unit.y
					greater_than=10
				[/variable]
			[/and]
			[then]
				[animate_unit]
					flag=pre_teleport
					[filter]
						x,y=$x1,$y1
					[/filter]
					[animate]
						[filter]
							id=Akula
						[/filter]
						flag=attack
						[primary_attack]
							range=ranged
						[/primary_attack]
						hits=yes
					[/animate]
				[/animate_unit]
			[/then]
			[else]
				[animate_unit]
					flag=pre_teleport
					[filter]
						x,y=$x1,$y1
					[/filter]
				[/animate_unit]
			[/else]
		[/if]
		[switch]
			variable=ch5_quests.amplificators_destroyed
			[case]
				value=4
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					{QUANTITY amount 2 3 4}
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=3
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					{QUANTITY amount 3 4 5}
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=2
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					amount=5
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=1
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					amount=7
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
			[case]
				value=0
				[harm_unit]
					[filter]
						x,y=$x2,$y2
					[/filter]
					amount=10
					{QUANTITY damage_type fire fire lightning}
					fire_event=yes
					experience=no
					animate=no
				[/harm_unit]
			[/case]
		[/switch]
	[/event]

	[event]
		name=moveto
		first_time_only=no
		[filter]
			side=1
			x,y=52,9
		[/filter]
		[message]
			speaker=narrator
			image="wesnoth-icon.png"
			message=_"On the monolith, there is a writing 'Vehicolul meu pe perna de aer e plin cu tipari' and five buttons. Which button will the unit press?"
			# The previous panel was an anagram. This one means 'My hovercraft is full of eels' in Romanian, that makes no sense.
			[option]
				label= _"First"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Second"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Third"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Fourth"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Fifth"
				[command]
				[/command]
			[/option]
		[/message]
		[message]
			speaker=narrator
			image="wesnoth-icon.png"
			message=_"Nothing happened. Which button should the unit press?"
			[option]
				label= _"First"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Second"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Third"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Fourth"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Fifth"
				[command]
				[/command]
			[/option]
		[/message]
		[message]
			speaker=narrator
			image="wesnoth-icon.png"
			message=_"Nothing happened. Which button should the unit press?"
			[option]
				label= _"First"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Second"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Third"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Fourth"
				[command]
				[/command]
			[/option]
			[option]
				label= _"Fifth"
				[command]
				[/command]
			[/option]
			[option]
				label= _"None, just scream that this makes no sense at all."		# Yes, it makes no sense. Try google translator.
				[command]
					{EARTHQUAKE (    {MODIFY_UNIT side=7 status.petrified no})}
					{VARIABLE secret_2 1}
					[set_global_variable]
						namespace=dugi_loti
						from_local=secret_2
						to_global=secret_2
						immediate=yes
					[/set_global_variable]
					{CLEAR_VARIABLE secret_2}
				[/command]
			[/option]
		[/message]
	[/event]
	[event]
		name=last breath
		[filter]
			id=akulas_sister
		[/filter]
		[message]
			speaker=akulas_sister
			message=_"Sister, your madness has led you too far. I fear that there is no redemption for you now."
			mirror=yes
			image_pos=right
		[/message]
		[message]
			speaker=Akula
			message=_"You were a fool to oppose me, you are the one who broke our family bond and caused this strife. And you received what deserve all those who betray their siblings. I gave you so many chances to redeem yourself, but you never took the chance."
		[/message]
	[/event]
	[event]
		name=last breath
		[filter]
			id=Akula
		[/filter]
		[message]
			speaker=second_unit
			message=_"I have defeated a great evil."
		[/message]
		[message]
			speaker=Akula
			message=_"Defeated by obsolete relics of times past... what a shame..."
		[/message]
		[message]
			speaker=Efraim
			message=_"Again, we are learning that the ones who follow the evil paths will be punished severely."
		[/message]
		[message]
			speaker=Lethalia
			message=_"Cutting away some limbs in the process?"
		[/message]
		[message]
			speaker=Akula
			message=_"By the way, you know that your effort was absolutely pointless? The mages were greatly offended by your slander, and decided to prove themselves powerful by creating an additional sun, despite King's orders."
		[/message]
		[message]
			speaker=Efraim
			message=_"Oh no, not again."
		[/message]
		[message]
			speaker=Akula
			message=_"Your friend Stormrider is trying to stop them, but he is overwhelmed by their magical defences, cumulated there for centuries. Soon, this whole land will become a dry desert and all the living will perish due to the heat. And my underlings will easily overwhelm them, conquering the world. It is a pity I will not lead them, but my plan will succeed anyway. And maybe they will find a way to resurrect me. Aaaaargh."
		[/message]
		[kill]
			id=Akula
			animate=yes
			fire_event=no
		[/kill]
		[message]
			speaker=akulas_sister
			message=_"Noooo! What an act of madness! Akula truly was a maniac encouraging such insane venture!"
			mirror=yes
			image_pos=right
		[/message]
		[message]
			speaker=Efraim
			message=_"I must confess that I am happy seeing her finally dead."
		[/message]
		[message]
			speaker=Lethalia
			message=_"But what shall we do now? I suggest to teleport ourselves there as quickly as possible and try to prevent that."
		[/message]
		[message]
			speaker=Efraim
			message=_"Well, prepare the spell."
		[/message]
		{VARIABLE chapter_5 1}
		[set_global_variable]
			namespace=dugi_loti
			from_local=chapter_5
			to_global=chapter_5
			immediate=yes
		[/set_global_variable]
		{CLEAR_VARIABLE chapter_5}
		[endlevel]
			result=victory
			bonus=yes
			linger_mode=no
			carryover_report=no
			bonus=no
			save=no
		[/endlevel]
	[/event]
#ifdef HARD
	[event]
		name=die
		id=side3_leader_dies
		[filter]
			side=3
			canrecruit=yes
			type=Lich_steel
		[/filter]
		{EARTHQUAKE (
			[terrain]
				terrain=Qxu^Bs\
				x=22
				y=13
			[/terrain]
			[if]
				[variable]
					name=ch5_quests.sc11.bridge_guardian.killed
					greater_than=0
				[/variable]
				[then]
					[terrain]
						terrain=Qxu^Bs\
						x=28
						y=16
					[/terrain]
				[/then]
			[/if]
		)}
		[delay]
			time=2000
		[/delay]
		[gold]
			side=2
			amount=400
		[/gold]
		[sound]
			name=gold.ogg
		[/sound]
		{PLACE_ITEM 37 $unit.x $unit.y}   # 100 gold
	[/event]
	[event]
		name=die
		id=side4_leader_dies
		[filter]
			side=4
			canrecruit=yes
			type=Lich_steel
		[/filter]
		{EARTHQUAKE (
			[terrain]
				terrain=Qxu^Bs/
				x=28
				y=13
			[/terrain]
			[if]
				[variable]
					name=ch5_quests.sc18.bridge_guardian.killed
					greater_than=0
				[/variable]
				[then]
					[terrain]
						terrain=Qxu^Bs\
						x=22
						y=16
					[/terrain]
				[/then]
			[/if]
		)}
		[delay]
			time=2000
		[/delay]
		[gold]
			side=2
			amount=400
		[/gold]
		[sound]
			name=gold.ogg
		[/sound]
		{PLACE_ITEM 37 $unit.x $unit.y}   # 100 gold
	[/event]
	[event]
		name=die
		id=side5_leader_dies
		[filter]
			side=5
			canrecruit=yes
			type=Lich_steel
		[/filter]
		{EARTHQUAKE (
			[terrain]
				terrain=Qxu^Bs|
				x=25
				y=18
			[/terrain]
			[if]
				[variable]
					name=ch5_quests.sc20.bridge_guardian.killed
					greater_than=0
				[/variable]
				[then]
					[terrain]
						terrain=Qxu^Bs|
						x=25
						y=12
					[/terrain]
				[/then]
			[/if]
		)}
		[delay]
			time=2000
		[/delay]
		[gold]
			side=2
			amount=400
		[/gold]
		[sound]
			name=gold.ogg
		[/sound]
		{PLACE_ITEM 37 $unit.x $unit.y}   # 100 gold
	[/event]
	[event]
		name=prerecruit
		id=walking_on_water_are_miracles_all_you_can_trust
		first_time_only=no
		[filter]
			side=2
		[/filter]
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			[modifications]
				[object]
					[effect]
						apply_to=movement_costs
						replace="true"
						[movement_costs]
							unwalkable=2
						[/movement_costs]
					[/effect]
				[/object]
			[/modifications]
		[/modify_unit]
	[/event]
	[event]
		name=prerecruit
		id=enemies_loyal
		first_time_only=no
		[filter]
			side=2,3,4,5
		[/filter]
		[modify_unit]
			[filter]
				id=$unit.id
			[/filter]
			upkeep=loyal
		[/modify_unit]
	[/event]
	[event]
		name=turn 2
		[filter_condition]
			[have_unit]  # With enough greater healing potions, this actual could fail, in which case player could never get through the shield
				id=enemy,enemy2,enemy3
			[/have_unit]
		[/filter_condition]
		[message]
			speaker=Akula
			message=_"Raise shields!"
		[/message]
		[terrain]  # Cut off access to Akula
			terrain=Xu^Ii
			x=   22,23,23,24,24,25,25,26,26,27,27,   28
			y=13-16,13,17,12,17,12,18,12,17,13,17,13-16
		[/terrain]
		[event]
			name=side 1 turn
			id=protective_barrier
			first_time_only=no
			[terrain]
				terrain=Xu^Ii
				[and]
					terrain=Qxua^Ii
				[/and]
			[/terrain]
			[store_unit]  # Don't want units to occupy shield tiles
				[filter]
					[filter_location]
						terrain=Xu^Ii
					[/filter_location]
				[/filter]
				variable=movers
				kill=yes
			[/store_unit]
			[foreach]
				array=movers
				[do]
					[unstore_unit]
						variable=this_item
						find_vacant=yes
					[/unstore_unit]
				[/do]
			[/foreach]
			{CLEAR_VARIABLE movers}
		[/event]
	[/event]

	[event]
		name=side 2 turn
		id=running_free
		first_time_only=no
		[terrain]
			terrain=Qxua^Ii
			[and]
				terrain=Xu^Ii
			[/and]
		[/terrain]
	[/event]
	[event]
		name=last breath
		id=necro2lich
		first_time_only=no
		[filter]
			id=enemy,enemy2,enemy3
			type=Necromancer_steel
		[/filter]
		[message]
			speaker=unit
			message= _ "Tharrr marr gra...  *zzzzt*  *whirrr*  *zzzzt*  *zzzzt* "
		[/message]
		[sound]
			name=mace.wav
		[/sound]
		[delay]
			time=200
		[/delay]
		[sound]
			name=lich-die.ogg
		[/sound]
		{VARIABLE unit.hitpoints 40}
		[for]
			array=unit.modifications.advancement
			[do]
				[if]
					[variable]
						name=unit.modifications.advancement[$i].id
						contains=legacy
					[/variable]
					[else]
						{CLEAR_VARIABLE unit.modifications.advancement[$i]}
						{VARIABLE_OP i sub 1}
					[/else]
				[/if]
			[/do]
		[/for]
		[for]
			array=unit.modifications.object
			[do]
				[if]
					[variable]
						name=unit.modifications.object[$i].sort
						equals=limited
					[/variable]
					[then]
						{CLEAR_VARIABLE unit.modifications.object[$i]}
						{VARIABLE_OP i sub 1}
					[/then]
				[/if]
			[/do]
		[/for]
		{CLEAR_VARIABLE unit.variables.may_need_respec,unit.variables.achieved_amla,unit.status}
		[unstore_unit]
			variable=unit
			find_vacant=no
		[/unstore_unit]
		[modify_side]
			side=$unit.side
			[ai]
				leader_aggression=0.8
			[/ai]
		[/modify_side]
		# it would be fun to change the recruit list here if there were some cool mechanical/undead units
		{ADVANCE_UNIT x,y=$x1,$y1 "Lich_steel"}
		{UPDATE_STATS}
	[/event]
#endif

#ifdef HARD
	[lua]  # animation and dialog for the catapults
		code = <<
local _ = wesnoth.textdomain "wesnoth-loti"

function  wesnoth.wml_actions.fire_catapult(cfg) 
		local units = wesnoth.units.find_on_map{ id = cfg.name }
		local catapult = wesnoth.units.find_on_map{ id = cfg.name }[1]
		local target = wesnoth.units.find_on_map{ id = cfg.target_id }[1]
		local hit_x = cfg.hit_x or target.x
		local hit_y = cfg.hit_y or target.y
		local delay = 250
		local catapult_data = {}
		catapult_data["catapult1"] = { float = _"napalm", you_msg = _"Did she just fire napalm at you?", me_msg = _"She just fired napalm at me!", response = _"I wonder that other tricks she has up her sleeve." }
		catapult_data["catapult2"] = { float = _"flechettes", you_msg = _"I think she just launched flechettes at you!", me_msg = _"She just launched flechettes at me!", response = _"That's not very nice!" }
		catapult_data["catapult3"] = { float = _"livestock", you_msg = _"Did she just fling a cow at you?", me_msg = _"She just flung a cow at me!", response = _"Gross!" }
		catapult_data["catapult4"] = { float = _"shrapnel", you_msg = _"Did she just shower you with shrapnel?", me_msg = _"She just showered me with shrapnel!", response = _"I'll shower <span font='italic'>her</span> with shrapnel, right after I tear her eyelids off so she can't help but watch!" }

		--wesnoth.interface.add_chat_message(string.format("Firing %s from %s (%d,%d) at %s (%d,%d), actual impact at %d,%d",catapult_data[catapult.id].float,catapult.id,catapult.x,catapult.y,target.name,target.x,target.y,hit_x,hit_y))
		wesnoth.interface.scroll_to_hex(catapult.x,catapult.y)
		wesnoth.audio.play("crossbow-fire.ogg")
		wesnoth.interface.add_hex_overlay(catapult.x,catapult.y,{ halo = "projectiles/fireball-impact-10.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(catapult.x,catapult.y)
		wesnoth.interface.add_hex_overlay(catapult.x,catapult.y,{ halo = "projectiles/fireball-impact-11.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(catapult.x,catapult.y)
		wesnoth.interface.add_hex_overlay(catapult.x,catapult.y,{ halo = "projectiles/fireball-impact-12.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(catapult.x,catapult.y)
		wesnoth.interface.add_hex_overlay(catapult.x,catapult.y,{ halo = "projectiles/fireball-impact-13.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(catapult.x,catapult.y)
		wesnoth.interface.add_hex_overlay(catapult.x,catapult.y,{ halo = "projectiles/fireball-impact-14.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(catapult.x,catapult.y)
		wesnoth.interface.float_label(catapult.x, catapult.y, "<span color='#ff0000'>" .. catapult_data[catapult.id].float .. "</span>")
		wesnoth.interface.delay(delay*2)
		wesnoth.interface.scroll_to_hex(hit_x,hit_y)
		-- insert flying sound here  (or Mooooooo for the cow)
		wesnoth.interface.delay(delay*2)
		wesnoth.interface.add_hex_overlay(hit_x,hit_y,{ halo = "projectiles/fireball-impact-7.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(hit_x,hit_y)
		wesnoth.interface.add_hex_overlay(hit_x,hit_y,{ halo = "projectiles/fireball-impact-8.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(hit_x,hit_y)
		wesnoth.interface.add_hex_overlay(hit_x,hit_y,{ halo = "projectiles/fireball-impact-9.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(hit_x,hit_y)
		wesnoth.interface.add_hex_overlay(hit_x,hit_y,{ halo = "projectiles/fireball-impact-10.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(hit_x,hit_y)
		wesnoth.interface.add_hex_overlay(hit_x,hit_y,{ halo = "projectiles/fireball-impact-11.png" } )
		wesnoth.interface.delay(delay)
		wesnoth.interface.remove_hex_overlay(hit_x,hit_y)

		local flag = "ch5_quests.sc23." .. catapult.id .. "fired_msg"
		if wml.variables[flag] ~= true then
				wml.variables[flag] = true
				if target.id ~= "Efraim" then
						wml.fire("message", { speaker = "Efraim", message = catapult_data[catapult.id].you_msg } )
				else
						wml.fire("message", { speaker = "Efraim", message = catapult_data[catapult.id].me_msg } )
				end
				wml.fire("message", { speaker = "Lethalia", message = catapult_data[catapult.id].response } )
		end
	-- insert witty banter here, based on who was the target and if they were hit/missed, etc
end
	>>
	[/lua]
	[event]
		name=side 2 turn
		id=catapult
		first_time_only=no
		[if]
			[have_unit]
				id=ally
			[/have_unit]
			[then]
				{VARIABLE_OP target rand (Efraim,Lethalia,ally)}
			[/then]
			[else]
				{VARIABLE_OP target rand (Efraim,Lethalia)}
			[/else]
		[/if]
		{VARIABLE_OP accuracy rand (0..2)}  # could get better as turns increase?  min(0,(3 - ceil($turn_number/10)))
		[store_unit]
			[filter]
				id=$target
			[/filter]
			variable=herostore
		[/store_unit]
		[store_locations]
			x,y=$herostore.x,$herostore.y
			radius=$accuracy
			include_borders=no
			variable=hit_locs
		[/store_locations]
		{VARIABLE_OP i rand (0.."$($hit_locs.length - 1)")}  # a random tile within $accuracy of $target (E/L/ally)
		{VARIABLE hit_x $hit_locs[$i].x}
		{VARIABLE hit_y $hit_locs[$i].y}
		[wml_message]
			logger=debug
			message="Targetting $herostore.name ($herostore.x,$herostore.y) within $accuracy, picked ($hit_locs[$i].x,$hit_locs[$i].y) from $hit_locs.length choices."  # TEST
		[/wml_message]
		#      4 catapults, 4 amplificators, coincidence? # amp could determine catapult existance/power/accuracy depending on level
		#   or 4 catapults - Mario, Connor, Ethiel, Skellie - a reward for keeping them alive and bringing them to the glorious final confrontation?
		#   or each catapult has a predetermined target (Mario, Connor, Ethiel, Skellie)
		{VARIABLE_OP catapult rand (catapult1,catapult2,catapult3,catapult4,"")}  # 20% chance of misfire
		[switch]
			variable=catapult
			[case]
				value="catapult1"  # napalm
				[if]
					[variable]
						name=target
						equals=ally
					[/variable]
					[then]  # Ally doesn't know how to handle being incinerated.  He's lucky that this catapult always misses him.  Funny that.
						[sound]
							name=crossbow-miss.ogg
						[/sound]
						[break][/break]
					[/then]
				[/if]
				[fire_catapult]
					name=$catapult
					target_id=$target
					hit_x=$hit_locs[$i].x
					hit_y=$hit_locs[$i].y
				[/fire_catapult]
				[harm_unit]
					[filter]
						x,y=$hit_locs[$i].x,$hit_locs[$i].y
					[/filter]
					damage_type=fire
					amount=8
					animate=no
				[/harm_unit]
				[store_unit]
					[filter]
						[filter_location]
							x,y=$hit_locs[$i].x,$hit_locs[$i].y
							radius=1
						[/filter_location]
					[/filter]
					variable=burned
				[/store_unit]
				[for]
					array=burned
					index=i
					[do]
						{VARIABLE burned[$i].status.incinerated yes}
						[unstore_unit]
							variable=burned[$i]
						[/unstore_unit]
						{VARIABLE is_red no}
						[foreach]
							array=burned[$i].modifications.object
							[do]
								[if]
									[variable]
										name=this_item.incineration
										equals=yes
									[/variable]
									[then]
										{VARIABLE is_red yes}
									[/then]
								[/if]
							[/do]
						[/foreach]
						[if]
							[variable]
								name=is_red
								equals=no
							[/variable]
							[then]
								{DEBUG_MSG "Setting red on $burned[$i].id ($burned[$i].x,$burned[$i].y)"}
								[object]
									silent=yes
									sort=potion-like
									remove_on_heal=yes
									incineration=yes
									[filter]
										id=$burned[$i].id
									[/filter]
									[effect]
										apply_to=image_mod
										add="CS(100,50,0)"
									[/effect]
								[/object]
							[/then]
						[/if]
						{CLEAR_VARIABLE is_red}

						[harm_unit]
							[filter]
								id=$burned[$i].id
							[/filter]
							damage_type=fire
							amount=8
							animate=yes
						[/harm_unit]
					[/do]
				[/for]
				{CLEAR_VARIABLE burned}
			[/case]
			[case]
				value="catapult2"  # flechette
				[fire_catapult]
					name=$catapult
					target_id=$target
					hit_x=$hit_locs[$i].x
					hit_y=$hit_locs[$i].y
				[/fire_catapult]
				[harm_unit]
					[filter]
						x,y=$hit_locs[$i].x,$hit_locs[$i].y
					[/filter]
					damage_type=pierce
					amount=8
					slowed=yes
					animate=no
				[/harm_unit]
				[harm_unit]
					[filter]
						[filter_location]
							x,y=$hit_locs[$i].x,$hit_locs[$i].y
							radius=1
						[/filter_location]
					[/filter]
					damage_type=pierce
					amount=8
					slowed=yes
					animate=yes
				[/harm_unit]
			[/case]
			[case]
				value="catapult3"  # cow
				[fire_catapult]
					name=$catapult
					target_id=$target
					hit_x=$hit_locs[$i].x
					hit_y=$hit_locs[$i].y
				[/fire_catapult]
				[harm_unit]
					[filter]
						x,y=$hit_locs[$i].x,$hit_locs[$i].y
					[/filter]
					damage_type=impact
					amount=8
					poisoned=yes
					animate=no
				[/harm_unit]
				[harm_unit]
					[filter]
						[filter_location]
							x,y=$hit_locs[$i].x,$hit_locs[$i].y
							radius=1
						[/filter_location]
					[/filter]
					damage_type=impact
					amount=8
					poisoned=yes
					animate=yes
				[/harm_unit]
			[/case]
			[case]
				value="catapult4"  # shrapnel
				[fire_catapult]
					name=$catapult
					target_id=$target
					hit_x=$hit_locs[$i].x
					hit_y=$hit_locs[$i].y
				[/fire_catapult]
				[harm_unit]
					[filter]
						x,y=$hit_locs[$i].x,$hit_locs[$i].y
					[/filter]
					damage_type=blade
					amount=8
					slowed=yes
					animate=no
				[/harm_unit]
				[harm_unit]
					[filter]
						[filter_location]
							x,y=$hit_locs[$i].x,$hit_locs[$i].y
							radius=1
						[/filter_location]
					[/filter]
					damage_type=blade
					amount=8
					slowed=yes
					animate=yes
				[/harm_unit]
			[/case]
			[else]
				[sound]
					name=crossbow-miss.ogg
				[/sound]
			[/else]
		[/switch]
		{CLEAR_VARIABLE target,accuracy,herostore,hit_locs,i,catapult}
	[/event]
#endif
	{STARTING_VILLAGES_ALL 2}
	{CAMPAIGN5_EVENTS}
	{DISABLE_UPKEEP 1}
	{SHOW_MAP}
	experience_modifier=125
[/scenario]
